#!/bin/bash


RUN_ID=$1
SPECIES=$2
RECEPTOR=$3
GERMLINE=$4

MY_PATH="`dirname \"$0\"`"              # relative
MY_PATH="`( cd \"${MY_PATH}\" && pwd )`"  # absolutized and normalized
if [ -z "$MY_PATH" ] ; then
  # error; for some reason, the path is not accessible
  # to the script (e.g. permissions re-evaled after suid)
  exit 1  # fail
fi

ROOT_PATH=/scicore/home/rexivy42/GROUP/pipelines/IgBLAST-massively
cd $ROOT_PATH

IGBLAST_VERSION=ncbi-igblast-1.14.0
IGBLAST_PATH=${ROOT_PATH}/releases/$IGBLAST_VERSION/bin
export PATH=${IGBLAST_PATH}:$PATH


# add group's anaconda/python to path
ANACONCA=$HOME/../GROUP/software/anaconda3/bin
export PATH=$ANACONCA:$PATH


#pip uninstall -y changeo
#pip install changeo --user
export PATH=${ROOT_PATH}/tools/changeo/bin:$PATH


KLEINSTEIN=${ROOT_PATH}/tools/kleinstein
export PATH=${KLEINSTEIN}:$PATH


#conda config --add channels bioconda
#conda install -y pandaseq


echo "Setting up IgBLAST pipeline"
echo ""


echo "Running from:"
echo ${ROOT_PATH}
echo ""
echo ""
echo ""
echo ""
echo "Pipeline is ready to run, using these references:"
echo "" 
echo "IgBLAST:"
igblastn -version
echo ""
echo "Using these paths:"
echo "IGBLAST:      $(which igblastn)"
echo "python3:      $(which python)"
echo "changeo:      $(which AssignGenes.py)"
echo "pandaseq:     $(which pandaseq)"
echo "kleinstein:   $(which fetch_imgtdb.sh)"
echo ""
find $ROOT_PATH/germlines/ -maxdepth 1 -printf "%f\n"





#############################################################
# Environment setup complete, Proceeding with annotation    #
#############################################################



INPUT_PAIRS=$ROOT_PATH/runs/$RUN_ID/input_fq.txt
INPUT_FASTA=$ROOT_PATH/runs/$RUN_ID/input_fasta.txt
NR_LINES=$(cat $INPUT_PAIRS | wc -l)

if [ $SLURM_ARRAY_TASK_ID -gt $NR_LINES ]
then

	IDX=`echo "$SLURM_ARRAY_TASK_ID - $NR_LINES" | bc`

	echo "eval \"sed '${IDX}q;d' $INPUT_FASTA\""
	F1=`eval "sed '${IDX}q;d' $INPUT_FASTA"`
	
	echo ""
	echo "this node will process"
	echo "lines	: $IDX"
	echo "input	: $INPUT_FASTA"
	echo ""
	echo $F1
	echo ""
	echo "species   : $SPECIES"
	echo "receptor  : $RECEPTOR"
	echo "germline  : $GERMLINE"


	echo ""
	echo ""
	
	echo "AssignGenes.py igblast -s $F1 -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format blast --nproc $SLURM_CPUS_PER_TASK"
	AssignGenes.py igblast -s $F1 -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format blast --nproc $SLURM_CPUS_PER_TASK

else

	IDX=`echo "3 * ( $SLURM_ARRAY_TASK_ID - 1 ) + 1" | bc`
	NXT=`echo "3 * ( $SLURM_ARRAY_TASK_ID - 1 ) + 2" | bc`


	echo "eval \"sed '${IDX}q;d' $INPUT_PAIRS\""
	F1=`eval "sed '${IDX}q;d' $INPUT_PAIRS"`
	echo "eval \"sed '${NXT}q;d' $INPUT_PAIRS\""
	F2=`eval "sed '${NXT}q;d' $INPUT_PAIRS"`

	echo ""
	echo "this node will process"
	echo "lines	: $IDX, $NXT"
	echo "input	: $INPUT_PAIRS"
	echo ""
	echo $F1
	echo $F2
	echo ""
	echo "species   : $SPECIES"
	echo "receptor  : $RECEPTOR"
	echo "germline  : $GERMLINE"


	echo ""
	echo ""
	FASTA=${F1/_R*.fast*/.fasta}
	pandaseq -f $F1 -r $F2 -w $FASTA -g $FASTA.log

	echo "AssignGenes.py igblast -s $FASTA -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format blast --nproc $SLURM_CPUS_PER_TASK"
	AssignGenes.py igblast -s $FASTA -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format blast --nproc $SLURM_CPUS_PER_TASK
fi
