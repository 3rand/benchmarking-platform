#!/bin/bash


RUN_ID=$1
SPECIES=$2
RECEPTOR=$3
GERMLINE=$4
NUMBER_OF_PAIR=$5
NUMBER_OF_PROCESSORS="16"

MY_PATH="`dirname \"$0\"`"              # relative
MY_PATH="`( cd \"${MY_PATH}\" && pwd )`"  # absolutized and normalized
if [ -z "$MY_PATH" ] ; then
  # error; for some reason, the path is not accessible
  # to the script (e.g. permissions re-evaled after suid)
  exit 1  # fail
fi

ROOT_PATH="$MY_PATH/../.."
cd $ROOT_PATH


echo "Setting up IgBLAST pipeline"
echo ""


echo "Running from:"
echo ${ROOT_PATH}
echo ""
echo ""
echo ""
echo ""
echo "Pipeline is ready to run, using these references:"
echo "" 
echo "IgBLAST:"
igblastn -version
echo ""
echo "Using these paths:"
echo "IGBLAST:      $(which igblastn)"
echo "python3:      $(which python)"
echo "changeo:      $(which AssignGenes.py)"
echo "pandaseq:     $(which pandaseq)"
echo "kleinstein:   $(which fetch_imgtdb.sh)"
echo ""
find $ROOT_PATH/germlines/ -maxdepth 1 -printf "%f\n"

#############################################################
# Environment setup complete, Proceeding with annotation    #
#############################################################

RUN_PATH="/home/$USER/igblast-runs/$RUN_ID"

INPUT_PAIRS=$RUN_PATH/input_fq.txt
INPUT_FASTA=$RUN_PATH/input_fasta.txt
NR_LINES_PAIRS=$(cat "$INPUT_PAIRS"  | wc -l )
NR_LINES_FASTA=$(cat "$INPUT_FASTA" | wc -l)
NR_PAIRS=$(echo "$NR_LINES_PAIRS / 3"  | bc )
TOTAL_TASK=$(echo "$NR_PAIRS + $NR_LINES_FASTA" | bc)

echo "PROCESSING TASK: $NUMBER_OF_PAIR out of $TOTAL_TASK"

if [ $NUMBER_OF_PAIR -gt $NR_PAIRS ]
then

	IDX=`echo "$NUMBER_OF_PAIR - $NR_PAIRS" | bc`

	echo "eval \"sed '${IDX}q;d' $INPUT_FASTA\""
	F1=`eval "sed '${IDX}q;d' $INPUT_FASTA"`
	
	echo ""
	echo "this node will process"
	echo "lines	: $IDX"
	echo "input	: $INPUT_FASTA"
	echo ""
	echo $F1
	echo ""
	echo "species   : $SPECIES"
	echo "receptor  : $RECEPTOR"
	echo "germline  : $GERMLINE"


	echo ""
	echo ""
	
	echo "AssignGenes.py igblast -s $F1 -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format airr --nproc $NUMBER_OF_PROCESSORS"
	AssignGenes.py igblast -s $F1 -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format airr --nproc $NUMBER_OF_PROCESSORS

else

	IDX=`echo "3 * ( $NUMBER_OF_PAIR - 1 ) + 1" | bc`
	NXT=`echo "3 * ( $NUMBER_OF_PAIR - 1 ) + 2" | bc`


	echo "eval \"sed '${IDX}q;d' $INPUT_PAIRS\""
	F1=`eval "sed '${IDX}q;d' $INPUT_PAIRS"`
	echo "eval \"sed '${NXT}q;d' $INPUT_PAIRS\""
	F2=`eval "sed '${NXT}q;d' $INPUT_PAIRS"`

	echo ""
	echo "this node will process"
	echo "lines	: $IDX, $NXT"
	echo "input	: $INPUT_PAIRS"
	echo ""
	echo $F1
	echo $F2
	echo ""
	echo "species   : $SPECIES"
	echo "receptor  : $RECEPTOR"
	echo "germline  : $GERMLINE"


	echo ""
	echo ""
	FASTA=${F1/_R*.fast*/.fasta}
	echo "found following fastas:$FASTA"
	pandaseq -f $F1 -r $F2 -w $FASTA -g $FASTA.log

	echo "AssignGenes.py igblast -s $FASTA -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format airr --nproc $NUMBER_OF_PROCESSORS"
	AssignGenes.py igblast -s $FASTA -b $GERMLINE  --organism $SPECIES --loci $RECEPTOR --format airr --nproc $NUMBER_OF_PROCESSORS
fi
